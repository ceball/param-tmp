<!DOCTYPE html>
<html lang="en">
 <head>
  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8"/>
  <title>
   param.version — Param 1.7.0.post15+gc6105c8 documentation
  </title>
  <meta content="Declarative Python programming using Parameters." name="description"/>
  <meta content="PyViz authors" name="author"/>
  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js">
  </script>
  <script>
   WebFont.load({
      google: {
        families: ['Source Sans Pro']
      }
    });
  </script>
  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="../../_static/css/main.css" rel="stylesheet"/>
  <link href="../../_static/nbsite.css" rel="stylesheet"/>
  <!-- Scripts
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js">
  </script>
  <script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript">
  </script>
  <script src="../../_static/js/main.js">
  </script>
  <script src="../../_static/nbsite.js">
  </script>
  <script src="../../_static/require.js">
  </script>
  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="../../_static/favicon.ico" rel="icon" type="image/png"/>
  <!-- Canonical
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="/_modules/param/version.html" rel="canonical"/>
 </head>
 <body class="">
  <header class="navigation">
   <div class="wrapper">
    <a class="logo" href="../../index.html">
     <img alt="Logo" src="../../_static/logo.png"/>
    </a>
    <a class="navigation-menu logo-text" href="../../index.html">
     Param
    </a>
    <a class="navigation-menu-button" href="javascript:void(0)" id="js-mobile-menu">
     Menu
    </a>
    <nav>
     <ul class="navigation-menu show" id="js-navigation-menu">
      <li class="nav-link">
       <a href="../../Reference_Manual/param.html">
        API
       </a>
      </li>
      <li class="nav-link">
       <a href="../../About.html">
        About
       </a>
      </li>
      <li class="nav-link">
       <div style="display:inline-block;vertical-align: middle;">
        <div class="search-bar">
         <form action="../../search.html" method="get" role="search">
          <input name="q" placeholder="Search" type="search"/>
          <button type="submit">
           <img alt="Search Icon" src="https://raw.githubusercontent.com/thoughtbot/refills/master/source/images/search-icon-black.png"/>
          </button>
         </form>
        </div>
       </div>
      </li>
     </ul>
    </nav>
   </div>
  </header>
  <!-- MAIN BODY OF DOCS –––––––––––––––––– -->
  <div class="docs section">
   <div id="hacketyhackhack">
    <!-- style="width:20%;margin-right: 100px;"> -->
    <!--style="display: none;"> style="display:none;"> -->
    <div class="toc" style="width:15%; margin-right:20px;">
     <ul>
      <li class="toctree-l1">
       <a class="reference internal" href="../../index.html">
        Introduction
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../Reference_Manual/param.html">
        API
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../About.html">
        About
       </a>
      </li>
     </ul>
    </div>
   </div>
   <div class="content">
    <!-- style="max-width:80%;margin-left:auto;margin-right: auto;">-->
    <h1>
     Source code for param.version
    </h1>
    <div class="highlight">
     <pre><span></span><span class="sd">"""</span>
<span class="sd">Provide consistent and up-to-date ``__version__`` strings for</span>
<span class="sd">Python packages.</span>

<span class="sd">See https://github.com/pyviz/autover for more information.</span>
<span class="sd">"""</span>

<span class="c1"># The Version class is a copy of autover.version.Version v0.2.5,</span>
<span class="c1"># except as noted below.</span>
<span class="c1">#</span>
<span class="c1"># The current version of autover supports a workflow based on tagging</span>
<span class="c1"># a git repository, and reports PEP440 compliant version information.</span>
<span class="c1"># Previously, the workflow required editing of version numbers in</span>
<span class="c1"># source code, and the version was not necessarily PEP440 compliant.</span>
<span class="c1"># Version.__new__ is added here to provide the previous Version class</span>
<span class="c1"># (OldDeprecatedVersion) if Version is called in the old way.</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s1">'Jean-Luc Stevens'</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                            <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
    <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>



<div class="viewcode-block" id="Version"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.Version">[docs]</a><span class="k">class</span> <span class="nc">Version</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A simple approach to Python package versioning that supports PyPI</span>
<span class="sd">    releases and additional information when working with version</span>
<span class="sd">    control. When obtaining a package from PyPI, the version returned</span>
<span class="sd">    is a string-formatted rendering of the supplied release tuple.</span>
<span class="sd">    For instance, release (1,0) tagged as ``v1.0`` in the version</span>
<span class="sd">    control system will return ``1.0`` for ``str(__version__)``.  Any</span>
<span class="sd">    number of items can be supplied in the release tuple, with either</span>
<span class="sd">    two or three numeric versioning levels typical.</span>

<span class="sd">    During development, a command like ``git describe`` will be used to</span>
<span class="sd">    compute the number of commits since the last version tag, the short</span>
<span class="sd">    commit hash, and whether the commit is dirty (has changes not yet</span>
<span class="sd">    committed). Version tags must start with a lowercase 'v' and have a</span>
<span class="sd">    period in them, e.g. v2.0, v0.9.8 or v0.1 and may include the PEP440</span>
<span class="sd">    prerelease identifiers of 'a' (alpha) 'b' (beta) or 'rc' (release</span>
<span class="sd">    candidate) allowing tags such as v2.0.a3, v0.9.8.b3 or v0.1.rc5.</span>

<span class="sd">    Also note that when version control system (VCS) information is</span>
<span class="sd">    used, the number of commits since the last version tag is</span>
<span class="sd">    determined. This approach is often useful in practice to decide</span>
<span class="sd">    which version is newer for a single developer, but will not</span>
<span class="sd">    necessarily be reliable when comparing against a different fork or</span>
<span class="sd">    branch in a distributed VCS.</span>

<span class="sd">    For git, if you want version control information available even in</span>
<span class="sd">    an exported archive (e.g. a .zip file from GitHub), you can set</span>
<span class="sd">    the following line in the .gitattributes file of your project::</span>

<span class="sd">      __init__.py export-subst</span>

<span class="sd">    Note that to support pip installation directly from GitHub via git</span>
<span class="sd">    archive, a .version file must be tracked by the repo to supply the</span>
<span class="sd">    release number (otherwise only the short SHA is available).</span>

<span class="sd">    The PEP440 format returned is [N!]N(.N)*[{a|b|rc}N][.postN+SHA]</span>
<span class="sd">    where everything before .postN is obtained from the tag, the N in</span>
<span class="sd">    .postN is the number of commits since the last tag and the SHA is</span>
<span class="sd">    obtained via git describe. This later portion is only shown if the</span>
<span class="sd">    commit count since the last tag is non zero. Instead of '.post', an</span>
<span class="sd">    alternate valid prefix such as '.rev', '_rev', '_r' or '.r' may be</span>
<span class="sd">    supplied."""</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c1"># If called in the old way, provide the previous class. Means</span>
        <span class="c1"># PEP440/tag based workflow warning below will never appear.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">'release'</span> <span class="ow">in</span> <span class="n">kw</span> <span class="ow">and</span> <span class="n">kw</span><span class="p">[</span><span class="s1">'release'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="s1">'dev'</span> <span class="ow">in</span> <span class="n">kw</span> <span class="ow">and</span> <span class="n">kw</span><span class="p">[</span><span class="s1">'dev'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="s1">'commit_count'</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OldDeprecatedVersion</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Version</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reponame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">commit_count_prefix</span><span class="o">=</span><span class="s1">'.post'</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        :release:      Release tuple (corresponding to the current VCS tag)</span>
<span class="sd">        :commit        Short SHA. Set to '$Format:%h$' for git archive support.</span>
<span class="sd">        :fpath:        Set to ``__file__`` to access version control information</span>
<span class="sd">        :reponame:     Used to verify VCS repository name.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">fpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="o">=</span> <span class="n">commit</span>

        <span class="k">if</span> <span class="n">release</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">'commit_count'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'WARNING: param.Version now supports PEP440 and a new tag based workflow. See param/version.py for more details'</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span> <span class="o">=</span> <span class="n">release</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="n">commit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">commit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"$Format"</span><span class="p">))</span> <span class="k">else</span> <span class="n">commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prerelease</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span><span class="o">=</span> <span class="n">archive_commit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">=</span> <span class="n">reponame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit_count_prefix</span> <span class="o">=</span> <span class="n">commit_count_prefix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prerelease</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Either None or one of 'aN' (alpha), 'bN' (beta) or 'rcN'</span>
<span class="sd">        (release candidate) where N is an integer.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_prerelease</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"Return the release tuple"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_release</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"A specification for this particular VCS version, e.g. a short git SHA"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_commit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commit_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"Return the number of commits since the last release"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_commit_count</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"True if there are uncommited changes, False otherwise"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_dirty</span>


<div class="viewcode-block" id="Version.fetch"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.Version.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns a tuple of the major version together with the</span>
<span class="sd">        appropriate SHA and dirty bit (for development version only).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span>
            <span class="k">return</span> <span class="bp">self</span>

         <span class="c1"># Only git right now but easily extended to SVN, Mercurial, etc.</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'git'</span><span class="p">,</span> <span class="s1">'git.cmd'</span><span class="p">,</span> <span class="s1">'git.exe'</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">git_fetch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="k">def</span> <span class="nf">git_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="s1">'git'</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">commit_argument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Verify this is the correct repository (since fpath could</span>
                <span class="c1"># be an unrelated git repository, and autover could just have</span>
                <span class="c1"># been copied/installed into it).</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'remote'</span><span class="p">,</span> <span class="s1">'-v'</span><span class="p">],</span>
                                 <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">))</span>
                <span class="n">repo_matches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">''</span><span class="p">,</span> <span class="c1"># No remote set</span>
                                <span class="s1">'/'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">+</span> <span class="s1">'.git'</span> <span class="p">,</span>
                                <span class="c1"># A remote 'server:reponame.git' can also be referred</span>
                                <span class="c1"># to (i.e. cloned) as `server:reponame`.</span>
                                <span class="s1">'/'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">+</span> <span class="s1">' '</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">repo_matches</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'describe'</span><span class="p">,</span> <span class="s1">'--long'</span><span class="p">,</span> <span class="s1">'--match'</span><span class="p">,</span>
                              <span class="s2">"v[0-9]*.[0-9]*.[0-9]*"</span><span class="p">,</span> <span class="s1">'--dirty'</span><span class="p">],</span>
                             <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">as_string</span><span class="p">:</span> <span class="k">return</span> <span class="n">output</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_from_file</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_from_vcs</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_stale</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">as_string</span><span class="p">:</span> <span class="k">return</span> <span class="n">output</span>

                <span class="c1"># If an explicit commit was supplied (e.g from git</span>
                <span class="c1"># archive), it should take precedence over the file.</span>
                <span class="k">if</span> <span class="n">commit_argument</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="n">commit_argument</span>
                <span class="k">return</span>

            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e1</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'fatal: No names found, cannot describe anything.'</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Cannot find any git version tags of format v*.*"</span><span class="p">)</span>
                <span class="c1"># If there is any other error, return (release value still useful)</span>
                <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_from_vcs</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_known_stale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        The commit is known to be from a file (and therefore stale) if a</span>
<span class="sd">        SHA is supplied by git archive and doesn't match the parsed commit.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_from_file</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span>

        <span class="n">known_stale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                       <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'$Format'</span><span class="p">)</span>
                       <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span> <span class="o">!=</span> <span class="n">commit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">known_stale</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">known_stale</span>

    <span class="k">def</span> <span class="nf">_output_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="o">=</span><span class="s1">'git_describe'</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Read the version from a .version file that may exist alongside __init__.py.</span>

<span class="sd">        This file can be generated by piping the following output to file:</span>

<span class="sd">        git describe --long --match v*.*</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">),</span> <span class="s1">'.version'</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vfile</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># File may be missing if using pip + git archive</span>
            <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_update_from_vcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="s2">"Update state based on the VCS state e.g the output of git describe"</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)</span>
        <span class="n">dot_split</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span><span class="s1">'b'</span><span class="p">,</span><span class="s1">'rc'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">prefix_split</span> <span class="o">=</span> <span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prerelease</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">prefix_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">dot_split</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="c1"># Strip out 'g' prefix ('g'=&gt;'git')</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">'dirty'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Version in x.y.z string format. Does not include the "v"</span>
<span class="sd">        prefix of the VCS version tags, for pip compatibility.</span>

<span class="sd">        If the commit count is non-zero or the repository is dirty,</span>
<span class="sd">        the string representation is equivalent to the output of::</span>

<span class="sd">          git describe --long --match v*.* --dirty</span>

<span class="sd">        (with "v" prefix removed).</span>
<span class="sd">        """</span>
        <span class="n">known_stale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_stale</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">known_stale</span><span class="p">:</span>
            <span class="n">extracted_directory_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_from_file</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="s1">'extracted_directory_tag'</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">'None'</span> <span class="k">if</span> <span class="n">extracted_directory_tag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">extracted_directory_tag</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">known_stale</span><span class="p">:</span>
            <span class="n">extracted_directory_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_from_file</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="s1">'extracted_directory_tag'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extracted_directory_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">extracted_directory_tag</span>
            <span class="k">return</span> <span class="s1">'0.0.0+g</span><span class="si">{SHA}</span><span class="s1">-gitarchive'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SHA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span><span class="p">)</span>

        <span class="n">release</span> <span class="o">=</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
        <span class="n">prerelease</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prerelease</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">prerelease</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">release</span> <span class="o">+</span> <span class="n">prerelease</span>

        <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span>
        <span class="n">dirty</span> <span class="o">=</span> <span class="s1">'-dirty'</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="k">else</span> <span class="s1">''</span>
        <span class="n">archive_commit</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="k">if</span> <span class="n">known_stale</span><span class="p">:</span>
            <span class="n">archive_commit</span> <span class="o">=</span> <span class="s1">'-gitarchive'</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span>

        <span class="k">if</span> <span class="n">archive_commit</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">:</span>
            <span class="n">postcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count_prefix</span> <span class="o">+</span> <span class="s1">'0'</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">postcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count_prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">postcount</span> <span class="o">=</span> <span class="s1">''</span>

        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">release</span><span class="p">,</span> <span class="n">prerelease</span><span class="p">,</span> <span class="n">postcount</span><span class="p">,</span>
                      <span class="s1">''</span> <span class="k">if</span> <span class="n">commit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">'+g'</span> <span class="o">+</span> <span class="n">commit</span><span class="p">,</span> <span class="n">dirty</span><span class="p">,</span>
                      <span class="n">archive_commit</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Version.abbrev"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.Version.abbrev">[docs]</a>    <span class="k">def</span> <span class="nf">abbrev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Abbreviated string representation of just the release number.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span></div>

<div class="viewcode-block" id="Version.verify"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.Version.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Check that the version information is consistent with the VCS</span>
<span class="sd">        before doing a release. If supplied with a string version,</span>
<span class="sd">        this is also checked against the current version. Should be</span>
<span class="sd">        called from setup.py with the declared package version before</span>
<span class="sd">        releasing to PyPI.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">string_version</span> <span class="ow">and</span> <span class="n">string_version</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Supplied string version does not match current version."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Current working directory is dirty."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Declared release does not match current release tag."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Please update the VCS version tag before release."</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span> <span class="s2">"$Format"</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Declared release does not match the VCS version tag"</span><span class="p">)</span></div>



<div class="viewcode-block" id="Version.get_setup_version"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.Version.get_setup_version">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_setup_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">setup_path</span><span class="p">,</span> <span class="n">reponame</span><span class="p">,</span> <span class="n">describe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">dirty</span><span class="o">=</span><span class="s1">'report'</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Helper for use in setup.py to get the version from the .version file (if available)</span>
<span class="sd">        or more up-to-date information from git describe (if available).</span>

<span class="sd">        Assumes the __init__.py will be found in the directory</span>
<span class="sd">        {reponame}/__init__.py relative to setup.py unless pkgname is</span>
<span class="sd">        explicitly specified in which case that name is used instead.</span>

<span class="sd">        If describe is True, the raw string obtained from git described is</span>
<span class="sd">        returned which is useful for updating the .version file.</span>

<span class="sd">        The dirty policy can be one of 'report', 'strip', 'raise'. If it is</span>
<span class="sd">        'report' the version string may end in '-dirty' if the repository is</span>
<span class="sd">        in a dirty state.  If the policy is 'strip', the '-dirty' suffix</span>
<span class="sd">        will be stripped out if present. If the policy is 'raise', an</span>
<span class="sd">        exception is raised if the repository is in a dirty state. This can</span>
<span class="sd">        be useful if you want to make sure packages are not built from a</span>
<span class="sd">        dirty repository state.</span>
<span class="sd">        """</span>
        <span class="n">pkgname</span> <span class="o">=</span> <span class="n">reponame</span> <span class="k">if</span> <span class="n">pkgname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pkgname</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'raise'</span><span class="p">,</span><span class="s1">'report'</span><span class="p">,</span> <span class="s1">'strip'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dirty</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">"get_setup_version dirty policy must be in </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">policies</span><span class="p">)</span>

        <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span> <span class="n">pkgname</span><span class="p">,</span> <span class="s2">"__init__.py"</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span> <span class="n">reponame</span><span class="o">=</span><span class="n">reponame</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">describe</span><span class="p">:</span>
            <span class="n">vstring</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">git_fetch</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vstring</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">dirty</span> <span class="ow">and</span> <span class="n">dirty</span> <span class="o">==</span> <span class="s1">'raise'</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">'Repository is in a dirty state.'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">version</span><span class="o">.</span><span class="n">dirty</span> <span class="ow">and</span> <span class="n">dirty</span><span class="o">==</span><span class="s1">'strip'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vstring</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'-dirty'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vstring</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_directory_tag</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">setup_path</span><span class="p">,</span> <span class="n">reponame</span><span class="p">):</span>
        <span class="n">setup_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setup_path</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Directory containing setup.py</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">reponame</span> <span class="o">+</span> <span class="s1">'-'</span> <span class="c1"># Prefix to match</span>
        <span class="k">if</span> <span class="n">setup_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">setup_dir</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>
            <span class="c1"># Assuming the tag is a version if it isn't empty, 'master' and has a dot in it</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">''</span><span class="p">,</span> <span class="s1">'master'</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">'.'</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">tag</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setup_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">setup_path</span><span class="p">,</span> <span class="n">reponame</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">pkgname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dirty</span><span class="o">=</span><span class="s1">'report'</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">git_describe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pkgname</span> <span class="o">=</span> <span class="n">reponame</span> <span class="k">if</span> <span class="n">pkgname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pkgname</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Will only work if in a git repo and git is available</span>
            <span class="n">git_describe</span>  <span class="o">=</span> <span class="n">Version</span><span class="o">.</span><span class="n">get_setup_version</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span>
                                                      <span class="n">reponame</span><span class="p">,</span>
                                                      <span class="n">describe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                      <span class="n">dirty</span><span class="o">=</span><span class="n">dirty</span><span class="p">,</span>
                                                      <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span>
                                                      <span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">git_describe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">'git_describe'</span><span class="p">]</span> <span class="o">=</span> <span class="n">git_describe</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

        <span class="k">if</span> <span class="n">git_describe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extracted_directory_tag</span> <span class="o">=</span> <span class="n">Version</span><span class="o">.</span><span class="n">extract_directory_tag</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span> <span class="n">reponame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extracted_directory_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">'extracted_directory_tag'</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_directory_tag</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span> <span class="n">pkgname</span><span class="p">,</span> <span class="s1">'.version'</span><span class="p">),</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">'extracted_directory_tag'</span><span class="p">:</span><span class="n">extracted_directory_tag</span><span class="p">}))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'Error in setup_version: could not write .version file.'</span><span class="p">)</span>


        <span class="n">info</span><span class="p">[</span><span class="s1">'version_string'</span><span class="p">]</span> <span class="o">=</span>  <span class="n">Version</span><span class="o">.</span><span class="n">get_setup_version</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span>
                                                            <span class="n">reponame</span><span class="p">,</span>
                                                            <span class="n">describe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                            <span class="n">dirty</span><span class="o">=</span><span class="n">dirty</span><span class="p">,</span>
                                                            <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span>
                                                            <span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span> <span class="n">pkgname</span><span class="p">,</span> <span class="s1">'.version'</span><span class="p">),</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Error in setup_version: could not write .version file.'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">info</span><span class="p">[</span><span class="s1">'version_string'</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_setup_version"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.get_setup_version">[docs]</a><span class="k">def</span> <span class="nf">get_setup_version</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">reponame</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Helper for use in setup.py to get the current version from either</span>
<span class="sd">    git describe or the .version file (if available).</span>

<span class="sd">    Set pkgname to the package name if it is different from the</span>
<span class="sd">    repository name.</span>

<span class="sd">    To ensure git information is included in a git archive, add</span>
<span class="sd">    setup.py to .gitattributes (in addition to __init__):</span>
<span class="sd">    ```</span>
<span class="sd">    __init__.py export-subst</span>
<span class="sd">    setup.py export-subst</span>
<span class="sd">    ```</span>
<span class="sd">    Then supply "$Format:%h$" for archive_commit.</span>

<span class="sd">    """</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="n">pkgname</span> <span class="o">=</span> <span class="n">reponame</span> <span class="k">if</span> <span class="n">pkgname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pkgname</span>
    <span class="k">if</span> <span class="n">archive_commit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"No archive commit available; git archives will not contain version information"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Version</span><span class="o">.</span><span class="n">setup_version</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">location</span><span class="p">)),</span><span class="n">reponame</span><span class="p">,</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span><span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_setupcfg_version"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.get_setupcfg_version">[docs]</a><span class="k">def</span> <span class="nf">get_setupcfg_version</span><span class="p">():</span>
    <span class="sd">"""As get_setup_version(), but configure via setup.cfg.</span>

<span class="sd">    If your project uses setup.cfg to configure setuptools, and hence has</span>
<span class="sd">    at least a "name" key in the [metadata] section, you can</span>
<span class="sd">    set the version as follows:</span>
<span class="sd">    ```</span>
<span class="sd">    [metadata]</span>
<span class="sd">    name = mypackage</span>
<span class="sd">    version = attr: autover.version.get_setup_version2</span>
<span class="sd">    ```</span>

<span class="sd">    If the repository name is different from the package name, specify</span>
<span class="sd">    `reponame` as a [tool:autover] option:</span>
<span class="sd">    ```</span>
<span class="sd">    [tool:autover]</span>
<span class="sd">    reponame = mypackage</span>
<span class="sd">    ```</span>

<span class="sd">    To ensure git information is included in a git archive, add</span>
<span class="sd">    setup.cfg to .gitattributes (in addition to __init__):</span>
<span class="sd">    ```</span>
<span class="sd">    __init__.py export-subst</span>
<span class="sd">    setup.cfg export-subst</span>
<span class="sd">    ```</span>

<span class="sd">    Then add the following to setup.cfg:</span>
<span class="sd">    ```</span>
<span class="sd">    [tool:autover.configparser_workaround.archive_commit=$Format:%h$]</span>
<span class="sd">    ```</span>

<span class="sd">    The above being a section heading rather than just a key is</span>
<span class="sd">    because setuptools requires % to be escaped with %, or it can't</span>
<span class="sd">    parse setup.cfg...but then git export-subst would not work.</span>

<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">configparser</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ConfigParser</span> <span class="k">as</span> <span class="nn">configparser</span> <span class="c1"># python2 (also prevents dict-like access)</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="s2">"setup.cfg"</span>
    <span class="n">autover_section</span> <span class="o">=</span> <span class="s1">'tool:autover'</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">pkgname</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'metadata'</span><span class="p">,</span><span class="s1">'name'</span><span class="p">)</span>
    <span class="n">reponame</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">autover_section</span><span class="p">,</span><span class="s1">'reponame'</span><span class="p">,</span><span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s1">'reponame'</span><span class="p">:</span><span class="n">pkgname</span><span class="p">})</span> <span class="k">if</span> <span class="n">autover_section</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span> <span class="k">else</span> <span class="n">pkgname</span>

    <span class="c1">###</span>
    <span class="c1"># hack archive_commit into section heading; see docstring</span>
    <span class="n">archive_commit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">archive_commit_key</span> <span class="o">=</span> <span class="n">autover_section</span><span class="o">+</span><span class="s1">'.configparser_workaround.archive_commit'</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">archive_commit_key</span><span class="p">):</span>
            <span class="n">archive_commit</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">".*=\s*(\S*)\s*"</span><span class="p">,</span><span class="n">section</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">###</span>
    <span class="k">return</span> <span class="n">get_setup_version</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span><span class="n">reponame</span><span class="o">=</span><span class="n">reponame</span><span class="p">,</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span><span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span></div>


<span class="c1"># from param/version.py aa087db29976d9b7e0f59c29789dfd721c85afd0</span>
<div class="viewcode-block" id="OldDeprecatedVersion"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.OldDeprecatedVersion">[docs]</a><span class="k">class</span> <span class="nc">OldDeprecatedVersion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A simple approach to Python package versioning that supports PyPI</span>
<span class="sd">    releases and additional information when working with version</span>
<span class="sd">    control. When obtaining a package from PyPI, the version returned</span>
<span class="sd">    is a string-formatted rendering of the supplied release tuple.</span>
<span class="sd">    For instance, release (1,0) tagged as ``v1.0`` in the version</span>
<span class="sd">    control system will return ``1.0`` for ``str(__version__)``.  Any</span>
<span class="sd">    number of items can be supplied in the release tuple, with either</span>
<span class="sd">    two or three numeric versioning levels typical.</span>

<span class="sd">    During development, a command like ``git describe`` will be used to</span>
<span class="sd">    compute the number of commits since the last version tag, the</span>
<span class="sd">    short commit hash, and whether the commit is dirty (has changes</span>
<span class="sd">    not yet committed). Version tags must start with a lowercase 'v'</span>
<span class="sd">    and have a period in them, e.g. v2.0, v0.9.8 or v0.1.</span>

<span class="sd">    Development versions are supported by setting the dev argument to an</span>
<span class="sd">    appropriate dev version number. The corresponding tag can be PEP440</span>
<span class="sd">    compliant (using .devX) of the form v0.1.dev3, v1.9.0.dev2 etc but</span>
<span class="sd">    it doesn't have to be as the dot may be omitted i.e v0.1dev3,</span>
<span class="sd">    v1.9.0dev2 etc.</span>

<span class="sd">    Also note that when version control system (VCS) information is</span>
<span class="sd">    used, the comparison operators take into account the number of</span>
<span class="sd">    commits since the last version tag. This approach is often useful</span>
<span class="sd">    in practice to decide which version is newer for a single</span>
<span class="sd">    developer, but will not necessarily be reliable when comparing</span>
<span class="sd">    against a different fork or branch in a distributed VCS.</span>

<span class="sd">    For git, if you want version control information available even in</span>
<span class="sd">    an exported archive (e.g. a .zip file from GitHub), you can set</span>
<span class="sd">    the following line in the .gitattributes file of your project::</span>

<span class="sd">      __init__.py export-subst</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">reponame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit_count</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        :release:      Release tuple (corresponding to the current VCS tag)</span>
<span class="sd">        :commit        Short SHA. Set to '$Format:%h$' for git archive support.</span>
<span class="sd">        :fpath:        Set to ``__file__`` to access version control information</span>
<span class="sd">        :reponame:     Used to verify VCS repository name.</span>
<span class="sd">        :dev:          Development version number. None if not a development version.</span>
<span class="sd">        :commit_count  Commits since last release. Set for dev releases.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">fpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="o">=</span> <span class="n">commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span> <span class="o">=</span> <span class="n">release</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">commit</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">"$Format:%h$"</span><span class="p">]</span> <span class="k">else</span> <span class="n">commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="n">commit_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">=</span> <span class="n">reponame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"Return the release tuple"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_release</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"A specification for this particular VCS version, e.g. a short git SHA"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_commit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commit_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"Return the number of commits since the last release"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_commit_count</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"True if there are uncommited changes, False otherwise"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_dirty</span>


<div class="viewcode-block" id="OldDeprecatedVersion.fetch"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.OldDeprecatedVersion.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns a tuple of the major version together with the</span>
<span class="sd">        appropriate SHA and dirty bit (for development version only).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span>
            <span class="k">return</span> <span class="bp">self</span>

         <span class="c1"># Only git right now but easily extended to SVN, Mercurial, etc.</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'git'</span><span class="p">,</span> <span class="s1">'git.cmd'</span><span class="p">,</span> <span class="s1">'git.exe'</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">git_fetch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="k">def</span> <span class="nf">git_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="s1">'git'</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Verify this is the correct repository (since fpath could</span>
                <span class="c1"># be an unrelated git repository, and param could just have</span>
                <span class="c1"># been copied/installed into it).</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'remote'</span><span class="p">,</span> <span class="s1">'-v'</span><span class="p">],</span>
                                 <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">))</span>
                <span class="n">repo_matches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'/'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">+</span> <span class="s1">'.git'</span> <span class="p">,</span>
                                <span class="c1"># A remote 'server:reponame.git' can also be referred</span>
                                <span class="c1"># to (i.e. cloned) as `server:reponame`.</span>
                                <span class="s1">'/'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">+</span> <span class="s1">' '</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">repo_matches</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'describe'</span><span class="p">,</span> <span class="s1">'--long'</span><span class="p">,</span> <span class="s1">'--match'</span><span class="p">,</span> <span class="s1">'v*.*'</span><span class="p">,</span> <span class="s1">'--dirty'</span><span class="p">],</span>
                             <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'fatal: No names found, cannot describe anything.'</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Cannot find any git version tags of format v*.*"</span><span class="p">)</span>
            <span class="c1"># If there is any other error, return (release value still useful)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_from_vcs</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_from_vcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="s2">"Update state based on the VCS state e.g the output of git describe"</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'dev'</span> <span class="ow">in</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">dev_split</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'dev'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dev_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Remove the pep440 dot if present</span>
            <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.'</span><span class="p">):</span>
                <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_split</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="c1"># Strip out 'g' prefix ('g'=&gt;'git')</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">'dirty'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>


    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Version in x.y.z string format. Does not include the "v"</span>
<span class="sd">        prefix of the VCS version tags, for pip compatibility.</span>

<span class="sd">        If the commit count is non-zero or the repository is dirty,</span>
<span class="sd">        the string representation is equivalent to the output of::</span>

<span class="sd">          git describe --long --match v*.* --dirty</span>

<span class="sd">        (with "v" prefix removed).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="s1">'None'</span>
        <span class="n">release</span> <span class="o">=</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
        <span class="n">release</span> <span class="o">=</span> <span class="s1">'</span><span class="si">%s</span><span class="s1">.dev</span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">release</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">release</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>  <span class="p">(</span><span class="s2">"$Format"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span><span class="p">):</span>
            <span class="k">pass</span>  <span class="c1"># Concrete commit supplied - print full version string</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">release</span>

        <span class="n">dirty_status</span> <span class="o">=</span> <span class="s1">'-dirty'</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="k">else</span> <span class="s1">''</span>
        <span class="k">return</span> <span class="s1">'</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-g</span><span class="si">%s%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">release</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="k">else</span> <span class="s1">'x'</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="n">dirty_status</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="OldDeprecatedVersion.abbrev"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.OldDeprecatedVersion.abbrev">[docs]</a>    <span class="k">def</span> <span class="nf">abbrev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dev_suffix</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Abbreviated string representation, optionally declaring whether it is</span>
<span class="sd">        a development version.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span> <span class="o">+</span> \
            <span class="p">(</span><span class="n">dev_suffix</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="k">else</span> <span class="s2">""</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Two versions are considered equivalent if and only if they are</span>
<span class="sd">        from the same release, with the same commit count, and are not</span>
<span class="sd">        dirty.  Any dirty version is considered different from any</span>
<span class="sd">        other version, since it could potentially have any arbitrary</span>
<span class="sd">        changes even for the same release and commit count.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
                <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">release</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">commit_count</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">dev</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">release</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dev</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">commit_count</span>
            <span class="k">elif</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">dev</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">dev</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">release</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">commit_count</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">==</span><span class="n">other</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">&gt;</span> <span class="n">other</span><span class="p">)</span>


<div class="viewcode-block" id="OldDeprecatedVersion.verify"><a class="viewcode-back" href="../../Reference_Manual/param.html#param.version.OldDeprecatedVersion.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Check that the version information is consistent with the VCS</span>
<span class="sd">        before doing a release. If supplied with a string version,</span>
<span class="sd">        this is also checked against the current version. Should be</span>
<span class="sd">        called from setup.py with the declared package version before</span>
<span class="sd">        releasing to PyPI.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">string_version</span> <span class="ow">and</span> <span class="n">string_version</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Supplied string version does not match current version."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Current working directory is dirty."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Declared release does not match current release tag."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Please update the VCS version tag before release."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">"$Format:%h$"</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Declared release does not match the VCS version tag"</span><span class="p">)</span></div></div>
</pre>
    </div>
   </div>
  </div>
  <!-- END MAIN BODY OF DOCS ––––––––––––– -->
  <footer class="footer">
   <div class="footer-links">
    <ul>
     <li>
      <span class="footer-title">
       Links
      </span>
     </li>
     <li>
      <a href="../../Reference_Manual/param.html">
       API
      </a>
     </li>
     <li>
      <a href="../../About.html">
       About
      </a>
     </li>
    </ul>
    <ul>
     <li>
      <span class="footer-title">
       Join Us
      </span>
     </li>
     <li>
      <a href="//gitter.im/ioam/holoviews">
       Gitter
      </a>
     </li>
     <li>
      <a href="//github.com/ioam/param">
       Github
      </a>
     </li>
    </ul>
    <ul class="copyright">
     <li>
      © 2005-2018, PyViz authors
     </li>
    </ul>
   </div>
  </footer>
  <!-- Google Analytics -->
  <script>
   (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-61554933-1', 'auto');
  ga('send', 'pageview');
  </script>
  <!-- MathJax Config -->
  <script type="text/x-mathjax-config">
   MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
});
  </script>
  <!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
 </body>
</html>